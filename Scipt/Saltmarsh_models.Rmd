---
title: "Saltmarsh mixed modelling"
author: "Dana Lanceman"
date: "2023-10-05"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This R script tests different types of modelling that can be applied to our saltmarsh functional traits dataset.

# 1. Set up


```{r Load packages}
#install.packages("readxl")
#install.packages("tidyverse")
#install.packages("lme4")
#install.packages("MuMIn")
#install.packages("car")
#install.packages("performance")
#install.packages("glmmTMB")
#install.packages("bbmle")
#install.packages("GLMMadaptive")
#install.packages("ggeffects")
#install.packages("emmeans")
#install.packages("robustlmm")

library(readxl)
library(tidyverse)
library(lme4)
library(MuMIn)
library(car)
library(performance)
library(glmmTMB)
library(bbmle)
library(GLMMadaptive)
library(ggeffects)
library(emmeans)
library(robustlmm)
```


```{r Get data}
# set working directory
setwd("C:/Users/z5204897/OneDrive - UNSW/Desktop/PhD/Data_analysis/Project/Functional_traits")

# input saltmarsh data
salt <- read_excel("Data/Functional_traits_combined_data.xlsx", sheet = "Saltmarsh") %>% 
  arrange(Date, Time) %>% 
  mutate(total_stems = Stems * 10000/Quad_length_cm^2, # add column for total stem count per 1m2 for each species to standardise stem counts
         Buds = case_when(  # reassign Buds as a numeric variable
           Buds == "Yes" ~ 1,
           Buds == "No" ~ 0,
           Buds == "Unknown" ~ NA,
           Buds == "NA" ~ NA
         ),
         Flowers = case_when(  # reassign Buds as a numeric variable
           Flowers == "Yes" ~ 1,
           Flowers == "No" ~ 0,
           Flowers == "Unknown" ~ NA,
           Flowers == "NA" ~ NA
         ),
         rest_status = case_when(
           Site == "AE" ~ as.numeric("1"),
           Site == "HS" ~ as.numeric("1"),
           Site == "TA" ~ as.numeric("1"),
           Site == "TB" ~ as.numeric("1"),
           Site == "CC" ~ as.numeric("1"),
           Site == "CF" ~ as.numeric("1"),
           Site == "DLW" ~ as.numeric("1"),
           .default = as.numeric("0"), # add a column for restoration status where 1 = restored and 0 = natural
         ),
         rest_year = case_when(
           Site == "AE" ~ as.numeric("2017"),
           Site == "HS" ~ as.numeric("2008"),
           Site == "TA" ~ as.numeric("2007"),
           Site == "TB" ~ as.numeric("2012"),
           Site == "CC" ~ as.numeric("1990"),
           Site == "CF" ~ as.numeric("1993"),
           Site == "DLW" ~ as.numeric("2014")
         ), # add a column for restoration years
         YSR = case_when(
           Site == "AE" ~ as.numeric("6"),
           Site == "HS" ~ as.numeric("15"),
           Site == "TA" ~ as.numeric("16"),
           Site == "TB" ~ as.numeric("11"),
           Site == "CC" ~ as.numeric("33"),
           Site == "CF" ~ as.numeric("30"),
           Site == "DLW" ~ as.numeric("9") #,
           #Site == "AI" ~ as.numeric("NA"), # figure out how best to include natural sites in model when they don't have a restoration age
           #Site == "SI" ~ as.numeric("NA"),
           #Site == "VSR" ~ as.numeric("NA"),
           #Site == "MWS" ~ as.numeric("NA"),
         ))  # add a column for years since restoration
# double check with Will years for each

# Create a column for the Dominant Species in each quadrat
salt <- salt %>%
  group_by(Combo) %>% 
  mutate(
    MaxSpeciesCover = max(`Sp_cover_%`),
    DomSpecies = ifelse(100 - `Total_cover_%` > MaxSpeciesCover, "unvegetated", #Species[which.max(`Sp_cover_%`)] # old code, but computes the first occurrence of the max cover so doesn't deal with "ties"
                        paste(unique(Species[`Sp_cover_%` == MaxSpeciesCover]), collapse = ", "))) %>% # Calculate the species with maximum cover for each Quadrat, and list multiple if it's a tie
  ungroup() %>%
  select(-MaxSpeciesCover) # Remove MaxSpeciesCover colummn

# For quadrats that have ended up listing two species as jointly dominant, manually edit these to include whichever of these species is "bulkier" as dominant
# i.e. Juncus > Triglochin, Sarcocornia > GSG, Juncus > Sporobolus

salt <- salt %>% mutate(
  DomSpecies = case_when(
    DomSpecies == "Juncus_kraussii, Sporobolus" ~ "Juncus_kraussii",
    DomSpecies == "Juncus_kraussii, Triglochin" ~ "Juncus_kraussii",
    DomSpecies == "GSG, Sarcocornia" ~ "Sarcocornia",
    .default = DomSpecies
  )
)

# create a column for proportion cover of each species (species cover/overall cover)
salt <- salt %>% mutate(sp_prop = `Sp_cover_%`/`Total_cover_%`)

# reassign Quadrat as an explictly nested variable within Site
salt$Quadrat <- as.character(salt$Quadrat)
salt$Quadrat.f <- factor(interaction(salt$Site, salt$Quadrat, sep = ":"))
salt$Quadrat.f <- as.character(salt$Quadrat.f)

```


```{r Create species-specific dataframes}
spor <- salt %>%
  filter(Species == "Sporobolus")

sarc <- salt %>%
  filter(Species == "Sarcocornia")

trig <- salt %>%
  filter(Species == "Triglochin")

pneu <- salt %>%
  filter(Species == "Pneumatophores")

```


Outlier removal - these were checked in the Saltmarsh_fn_traits script.

```{r Remove unrealistic outliers}
salt[443,20] <- NA # remove triglochin measurement with unrealistic stem diameter >4mm
salt[c(738-744), 20] <- NA # remove triglochin measurements with unrealistic stem diameter >4mm
salt[802,19] <- NA # remove triglochin measurement with unrealistic stem height 556mm
salt[1271,19] <- NA # remove triglochin measurement with unrealistic stem height 860mm
salt[112,20] <- NA # remove pneumatophore measurement with unrealistic diameter 1mm
salt[c(862,917),20] <- NA # remove sporobolus measurements with unrealistic diameters > 4mm

trig[121,19] <- NA # this value had stem height of 556mm
trig[240,19] <- NA # this value had stem height of 860mm
trig[c(98:104),20] <- NA # these had stem diameters > 4mm
trig[78,20] <- NA # stem diameter was > 4mm
pneu[40,20] <- NA # this had stem diameter of 1mm
spor[c(283,313),20] <- NA # remove sporobolus measurements with unrealistic diameters > 4mm
```


Data transformations - need to check whether these are required for these models. If so, need to check across-species assumptions.
```{r Data transformations}
# overall saltmarsh
salt$ln.canopy.ht <- log(salt$Canopy_ht_cm)

# sporobolus
spor$ln.stem.ht <- log(spor$Stem_ht_mm)
spor$sq.stem.ht <- sqrt(spor$Stem_ht_mm)
spor$ln.stem.dia <- log(spor$Stem_dia_mm + 0.01)
spor$sq.stem.dia <- sqrt(spor$Stem_dia_mm)
spor$sq.stem.dens <- sqrt(spor$total_stems)

# sarcocornia
sarc$sq.stem.dia <- sqrt(sarc$Stem_dia_mm)
sarc$sq.stem.dens <- sqrt(sarc$total_stems)

# triglochin
trig$ln.sp.cover <- log(trig$`Sp_cover_%` + 0.01)
trig$sq.stem.dia <- sqrt(trig$Stem_dia_mm)
trig$ln.stem.dens <- log(trig$total_stems)

# pneumatophores
pneu$sq.sp.cover <- sqrt(pneu$`Sp_cover_%`)
pneu$sq.stem.dens <- sqrt(pneu$total_stems)
```


Also not sure if this is needed for this particular model, but it can be useful to rescale explanatory variables so they have a constant mean of 0 and standard deviation of 1.
```{r Rescale/standardise explanatory variables}
salt$Elevation <- scale(salt$Elevation, center = TRUE, scale = TRUE)
spor$Elevation <- scale(spor$Elevation, center = TRUE, scale = TRUE)
sarc$Elevation <- scale(sarc$Elevation, center = TRUE, scale = TRUE)
trig$Elevation <- scale(trig$Elevation, center = TRUE, scale = TRUE)
pneu$Elevation <- scale(pneu$Elevation, center = TRUE, scale = TRUE)

```


Duplicate deletion - for community-level variables, there are several rows for each quadrat that are all identical. We need to remove these duplicate rows

```{r Duplicate deletion - community-level variables}
salt_comm <- salt %>% distinct(Combo, .keep_all = TRUE) 
salt_comm <- salt_comm[,-c(11:20,22,26,31)] # remove irrelevant rows
# turn total cover into a proportion between 0 and 1 instead of between 0 and 100
salt_comm <- salt_comm %>% mutate(total_cover_prop = `Total_cover_%`/100 -0.001)
# also included a tiny offset since it doesn't like values of exactly 1 - must be below 1.

spor_comm <- spor %>% distinct(Combo, .keep_all = TRUE) 
spor_comm <- spor_comm[,-c(19,20,33:36)] # remove irrelevant rows

sarc_comm <- sarc %>% distinct(Combo, .keep_all = TRUE) 
sarc_comm <- sarc_comm[,-c(19,20,33)] # remove irrelevant rows

trig_comm <- trig %>% distinct(Combo, .keep_all = TRUE) 
trig_comm <- trig_comm[,-c(19,20,34)] # remove irrelevant rows

pneu_comm <- pneu %>% distinct(Combo, .keep_all = TRUE) 
pneu_comm <- pneu_comm[,-c(19,20)] # remove irrelevant rows
  
```

Create datasets for just restored data and just natural data
```{r Subsetting dataframes}
salt_H <- salt %>% subset(Estuary == "Hunter")
spor_H <- spor %>% subset(Estuary == "Hunter")
sarc_H <- sarc %>% subset(Estuary == "Hunter")
trig_H <- trig %>% subset(Estuary == "Hunter")
pneu_H <- pneu %>% subset(Estuary == "Hunter")

spor_H_rest <- spor_H %>% subset(rest_status == 1)
sarc_H_rest <- sarc_H %>% subset(rest_status == 1)
trig_H_rest <- trig_H %>% subset(rest_status == 1)
pneu_H_rest <- pneu_H %>% subset(rest_status == 1)

spor_H_nat <- spor_H %>% subset(rest_status == 0)
sarc_H_nat <- sarc_H %>% subset(rest_status == 0)
trig_H_nat <- trig_H %>% subset(rest_status == 0)
pneu_H_nat <- pneu_H %>% subset(rest_status == 0)

salt_comm_rest <- salt_comm %>% subset(salt_comm$rest_status == 1)
salt_comm_nat <- salt_comm %>% subset(salt_comm$rest_status == 0)
salt_comm_rest_H <- salt_comm_rest %>% subset(salt_comm_rest$Estuary == "Hunter")
salt_comm_nat_H <- salt_comm_nat %>% subset(salt_comm_nat$Estuary == "Hunter")
salt_comm_H <- salt_comm %>% subset(salt_comm$Estuary == "Hunter")

spor_comm_H <- spor_comm %>% subset(Estuary == "Hunter")
sarc_comm_H <- sarc_comm %>% subset(Estuary == "Hunter")
trig_comm_H <- trig_comm %>% subset(Estuary == "Hunter")
pneu_comm_H <- pneu_comm %>% subset(Estuary == "Hunter")

# Hunter only, restored only 
spor_comm_H_res <- spor_comm_H %>% subset(rest_status == "1")
sarc_comm_H_res <- sarc_comm_H %>% subset(rest_status == "1")
trig_comm_H_res <- trig_comm_H %>% subset(rest_status == "1")
pneu_comm_H_res <- pneu_comm_H %>% subset(rest_status == "1")

# Hunter only, natural only 
spor_comm_H_nat <- spor_comm_H %>% subset(rest_status == "0")
sarc_comm_H_nat <- sarc_comm_H %>% subset(rest_status == "0")
trig_comm_H_nat <- trig_comm_H %>% subset(rest_status == "0")
pneu_comm_H_nat <- pneu_comm_H %>% subset(rest_status == "0")
```


# A. Hunter only

# 2. Simple trial models - community level

First, let's create univariate models for our community-level variables (tallest canopy height, total cover and burrows).


# 2a Tallest canopy height

Tallest canopy height
- Canopy height ~ YSR + DomSpecies + Elevation + (1|Site)

First assumption: linear relationship between predictors and response variable

```{r Tallest canopy height - check assumptions - linear relationship }
# numeric predictors are YSR and elevation
plot(salt_comm$Canopy_ht_cm ~ salt_comm$YSR) # possibly non-linear
plot(salt_comm$Canopy_ht_cm ~ salt_comm$Elevation) # possibly non-linear
```


```{r Tallest canopy height - model}
M <- lmer(Canopy_ht_cm ~ YSR + DomSpecies + Elevation + (1|Site), data = salt_comm_rest_H, na.action = na.exclude)
summary(M)

# YSR is significant
# DomSpeciesPhragmites is significant, DomSpeciesSarcocornia is significant, DomSpeciesSporobolus is significant, DomSpeciesSuaeda is significant, DomSpeciesTriglochin is significant, DomSpeciesunvegetated is significant
# Site explains 117/372 = 31% of the variance not explained by fixed effects

M1 <- lmer(ln.canopy.ht ~ YSR + DomSpecies + Elevation + (1|Site), data = salt_comm_rest_H, na.action = na.exclude)
# check whether this model makes sense and whether rest_status:rest_year is the correct way to add rest_year as a fixed factor nested within rest_status
# this model gives a warning message about dropping a variable unless we assign "restoration ages" to the natural sites
summary(M1)

# elevation is significant in this model

# try a model with polynomial variables
M2 <- lmer(Canopy_ht_cm ~ poly(YSR,2) + DomSpecies + poly(Elevation,2) + (1|Site), data = salt_comm_rest_H, na.action = na.exclude)
summary(M2)

# estimate > st error for 2nd order polynomial YSR & 1st order polynomial
# 1st order elevation is significant here

# try a model with polynomial variables and log transform
M3 <- lmer(ln.canopy.ht ~ poly(YSR,2) + DomSpecies + poly(Elevation,2) + (1|Site), data = salt_comm_rest_H, na.action = na.exclude)
summary(M3)

# remove non-significant factors - polynomial elevation

M3 <- lmer(ln.canopy.ht ~ poly(YSR,2) + DomSpecies + Elevation + (1|Site), data = salt_comm_rest_H, na.action = na.exclude)
summary(M3)
```

Other assumptions:
- model residuals are normally distributed
- model residuals have equal variances
- model residuals are independent

```{r Tallest canopy height - check residuals assumptions}
# check for collinearity between predictors
check_collinearity(M) # VIF < 5 (low collinearity) - good.

# residuals plots
plot(M) # roughly equal variances
qqnorm(resid(M)) 
qqline(resid(M)) # not normal

# try M1 with log-transformed response variable
# check for collinearity between predictors
check_collinearity(M1) # VIF < 5 (low collinearity) - good.

# residuals plots
plot(M1) # roughly equal variances / slightly worse than before
qqnorm(resid(M1)) 
qqline(resid(M1)) # closer to normal, but not great (high values diverge)

# try M2 with polynomial variables
# check for collinearity between predictors
check_collinearity(M2) # VIF < 5 (low collinearity) - good.

# residuals plots
plot(M2) # roughly equal variances / slightly worse than before
qqnorm(resid(M2)) 
qqline(resid(M2)) # not great

# try M3 
# check for collinearity between predictors
check_collinearity(M3) # VIF < 5 (low collinearity) - good.

# residuals plots
plot(M3) # roughly equal variances / slightly worse than before
qqnorm(resid(M3)) 
qqline(resid(M3)) # not good at all. don't use this one.

# use log transformed rather than non-transformed
# confirm if this is good enough
```

```{r Tallest canopy height - plot}
# Years since restoration
ggplot(salt_comm_rest_H, aes(x = YSR, y = ln.canopy.ht)) +   
      geom_point(alpha = 0.5, na.rm = TRUE) +
      geom_smooth(span = 10) +
    scale_y_continuous(breaks = log(pretty(exp(salt_comm$ln.canopy.ht))), labels = pretty(exp(salt_comm$ln.canopy.ht))) +
    labs(y = "Canopy height (cm)", x = "Years since restoration") +
      theme_classic()

# plot predicted values with ggeffects ggemmeans
predict_YSR <- ggemmeans(M2, terms = c("YSR [all]"))
# view this result
print(predict_YSR)
# visualise this result
plot(predict_YSR, ci = T,add.data = TRUE, dot.alpha = 0.5,  jitter = 0.2)+
  ggtitle("") +  geom_line(size = 1.2) +
  labs(y = "Tallest stem height (cm)", x = "Years since restoration") +
  theme_classic()

# natural sites boxplot
ggplot(salt_comm_nat_H, aes(x = Site, y = ln.canopy.ht)) +
  geom_boxplot() +
    scale_y_continuous(breaks = log(pretty(exp(salt_comm$ln.canopy.ht))), labels = pretty(exp(salt_comm$ln.canopy.ht)))   +
  geom_point() +
    labs(y = "Canopy height (cm)") +
  theme_classic()

# Elevation
ggplot(salt_comm_rest_H, aes(x = Elevation, y = ln.canopy.ht)) +   
      geom_point(alpha = 0.5, na.rm = TRUE) +
      geom_smooth(method = lm) +
    scale_y_continuous(breaks = log(pretty(exp(salt_comm$ln.canopy.ht))), labels = pretty(exp(salt_comm$ln.canopy.ht))) +
    labs(y = "Canopy height (cm)", x = "Elevation (standardised)") +
      theme_classic() 
# ideally back-transform the elevation axis

# Dominant species
salt_comm_rest_H %>% 
  subset(DomSpecies %in% c("Bolboschoenus", "Phragmites", "Sarcocornia", "Sporobolus", "Triglochin")) %>% 
  ggplot(., aes(x = DomSpecies, y = ln.canopy.ht)) +
  geom_boxplot() +
    scale_y_continuous(breaks = log(pretty(exp(salt_comm$ln.canopy.ht))), labels = pretty(exp(salt_comm$ln.canopy.ht)))   +
  geom_point() +
    labs(y = "Canopy height (cm)") +
  theme_classic()
# aster, juncus, suaeda and unvegetated only have one value each so should be excluded from the plot and (maybe) model.
```


# 2b - Total cover 

Total cover
- Total cover ~ YSR + DomSpecies + Elevation + (1|Site)
- beta distribution (proportional data with 2 categories - cover and non cover)


```{r Total cover - model}
M <- glmmTMB(total_cover_prop ~ YSR + DomSpecies + Elevation + (1|Site), data = salt_comm_rest_H, family = beta_family(link = "logit"), na.action = na.exclude)
summary(M)
# YSR is near-significant
# unvegetated is very signficant which makes sense
# elevation is significant
```

Other assumptions (??)

```{r Total cover - plot}
# Years since restoration
ggplot(salt_comm_rest_H, aes(x = YSR, y = total_cover_prop)) +   
      geom_point(alpha = 0.5, na.rm = TRUE) +
      geom_smooth(method = lm) +
    labs(y = "Total cover (proportion)", x = "Years since restoration") +
      theme_classic()
# all look very similar

# plot predicted values with ggeffects ggemmeans
predict_YSR <- ggemmeans(M, terms = c("YSR [all]"))
# view this result
print(predict_YSR)
# visualise this result
plot(predict_YSR, ci = T,add.data = TRUE, dot.alpha = 0.5,  jitter = 0.2)+
  ggtitle("") +  geom_line(size = 1.2) +
  labs(y = "Total cover (proportion)", x = "Years since restoration") +
  theme_classic()

# plot natural boxplots
ggplot(salt_comm_nat_H, aes(x = Site, y = total_cover_prop)) +
  geom_boxplot()  +
  geom_point() +
    labs(y = "Canopy height (cm)") +
  theme_classic()

# Elevation
ggplot(salt_comm_rest_H, aes(x = Elevation, y = total_cover_prop)) +   
      geom_point(alpha = 0.5, na.rm = TRUE) +
      geom_smooth(method = lm) +
    labs(y = "Total cover (proportion)", x = "Elevation (standardised)") +
      theme_classic() 
# looks very similar
# ideally back-transform the elevation axis
```


#2c - burrows

```{r Zero-inflation testing and model approach}
# test for zero-inflation

100*sum(salt_comm_rest_H$Burrows_0.5x0.5 == 0, na.rm = TRUE)/nrow(salt_comm_rest_H)
# 58% of our data are zeroes

# check if this number of zeroes can be predicted under a poisson model
M1 <- glmmTMB(Burrows_0.5x0.5 ~ poly(YSR,2) + DomSpecies + Elevation + (1|Site),
          family = 'poisson',
          data = salt_comm_rest_H)

summary(M1)

## Check for over/underdispersion in the model
E2 <- resid(M1, type = "pearson")
N  <- nrow(salt_comm_rest_H)
p  <- length(coef(M1))   
sum(E2^2) / (N - p)

# 5.75 > 1 - evidence of overdispersion

# check if this number of zeroes can be predicted under a negative binomial model
# without restoration status for now

## Check which type of negative binomial to use!!

M2 <- glmmTMB(Burrows_0.5x0.5 ~ poly(YSR,2) + Elevation + DomSpecies + (1|Site),
          family = 'nbinom1',
          data = salt_comm_rest_H)

summary(M2)

## Check for over/underdispersion in the model
E2 <- resid(M2, type = "pearson")
N  <- nrow(salt_comm_rest_H)
p  <- length(coef(M2))   
sum(E2^2) / (N - p)

# 2.10 > 1 therefore still highly overdispersed

M3 <- glmmTMB(Burrows_0.5x0.5 ~ poly(YSR,2) + Elevation + DomSpecies + (1|Site),
          family = 'nbinom2',
          data = salt_comm_rest_H)

summary(M3)

## Check for over/underdispersion in the model
E2 <- resid(M3, type = "pearson")
N  <- nrow(salt_comm_rest_H)
p  <- length(coef(M3))   
sum(E2^2) / (N - p)

# 0.86 therefore underdispersed / kind of close to even!

# compare the different models
AICtab(M1, M2, M3)
# lower values indicate a better model fit. M2 (negative binomial 1) has the best fit. However it is overdispersed. M3 is relatively close to M2 and has close to even dispersion so use it.
```

```{r Burrows - M3 - negative binomial 2 model}
M3 <- glmmTMB(Burrows_0.5x0.5 ~ poly(YSR,2) + Elevation + DomSpecies + (1|Site),
          family = 'nbinom2',
          data = salt_comm_rest_H)

summary(M3)
```

Not sure how to best plot this.

```{r Burrows - plot}
# Years since restoration
ggplot(salt_comm_rest_H, aes(x = YSR, y = Burrows_0.5x0.5)) +   
      geom_point(alpha = 0.5, na.rm = TRUE) +
      geom_smooth(span = 10)  +
    labs(y = "Burrows", x = "Years since restoration") +
      theme_classic()

# natural only
ggplot(salt_comm_nat_H, aes(x = Site, y = Burrows_0.5x0.5)) +
  geom_boxplot()  +
  geom_point() +
    labs(y = "Burrows") +
  theme_classic()

# predict effects of YSR when controlling for the other factors
# this plot needs work - not sure what the y axis is??
predict_YSR <- ggemmeans(M3, terms = c("YSR [all]"))
# view this result
print(predict_YSR)
# visualise this result
plot(predict_YSR, ci = T) +
  ggtitle("") +  geom_line(size = 1.2) +
  labs(y = "Burrows", x = "Years since restoration") +
  theme_classic() 
```


```{r Also need to test restoration status}
M4 <- glmmTMB(Burrows_0.5x0.5 ~ rest_status + Elevation + DomSpecies + (1|Site),
          family = 'nbinom2',
          data = salt_comm_H)

summary(M4)

# check dispersion issues for this model
E2 <- resid(M4, type = "pearson")
N  <- nrow(salt_comm_rest_H)
p  <- length(coef(M4))   
sum(E2^2) / (N - p)

# 1.62 = overdispersed but not too bad?
```


# 3. Simple trial models - species level

# 3a - Sporobolus

Sporobolus stem density, height and diameter

Explanatory variables:
- restoration status (binary) OR YSR (continuous), depending on the model
- Elevation (continuous)
- Site (random, nested in restoration status)
- Quadrat (for stem height and diameter, unless we average them) (random, nested in Site in restoration status)
- Dominant species (categorical)
- species proportional cover (continuous)


```{r Sporobolus continuous depedent variables - check correlations}
plot(spor_H$total_stems ~ spor_H$Stem_dia_mm) # not correlated
plot(spor_H$Stem_ht_mm ~ spor_H$Stem_dia_mm) # not correlated
plot(spor_H$total_stems ~ spor_H$Stem_ht_mm) # not correlated

# therefore can model all three variables, as none are correlated
```

Should we only include Dominant Species of interest?

# 3ai. Sporobolus stem height

```{r Sporobolus stem height - initial assumptions}
# test assumptions - linear relationship between predictors and response
# numeric predictors are species proportional cover and elevation
plot(spor_H$Stem_ht_mm ~ spor_H$sp_prop) # potentially slightly non-linear, and clearly stem height is 1-inflated. Need to figure out if this is an issue and if there's anything I can do about it.
ggplot(spor_H, aes(x = sp_prop, y = Stem_ht_mm)) +
  geom_point() +
  geom_smooth(span = 1) 

plot(spor_H$Stem_ht_mm ~ spor_H$Elevation) # looks non-linear
ggplot(spor_H, aes(x = Elevation, y = Stem_ht_mm)) +
  geom_point() +
  geom_smooth(span = 0.5)
# therefore try including these variables as non-linear predictor variables. Maybe a quadratic and cubic function respectively?

plot(spor_H$Stem_ht_mm ~ spor_H$YSR) # not sure
ggplot(spor_H, aes(x = YSR, y = Stem_ht_mm)) +
  geom_point() +
  geom_smooth(span = 0.8) # maybe non-linear
```


```{r Sporobolus stem height - restoration status - Model building}
# create model
M_spor_H_stem_ht <- lmer(Stem_ht_mm ~ rest_status + poly(Elevation,3) + DomSpecies + poly(sp_prop,2) + (1|Site) + (1|Quadrat.f), data = spor_H, na.action = na.exclude)
# do I need to specify nesting here or will the model figure out due to the unique labelling of factors?
summary(M_spor_H_stem_ht)

# 3rd order polynomial elevation was non-significant, so include as a 2nd order polynomial
M_spor_H_stem_ht <- lmer(Stem_ht_mm ~ rest_status + poly(Elevation,2) + DomSpecies + poly(sp_prop,2) + (1|Site) + (1|Quadrat.f), data = spor_H, na.action = na.exclude)
summary(M_spor_H_stem_ht)

# check more model assumptions
# check for collinearity between predictors
check_collinearity(M_spor_H_stem_ht) # VIF ~ 6 (moderate collinearity) 
# species proportions and dominance are correlated here - drop one.

# drop DomSpecies predictor variable as it has the highest VIF
M <- lmer(Stem_ht_mm ~ rest_status + poly(Elevation,2) + poly(sp_prop, 2) + (1|Site) + (1|Quadrat.f), data = spor_H, na.action = na.exclude)
summary(M)

# check for collinearity between predictors
check_collinearity(M) # VIF are all <5 (low collinearity)

# residuals plots
plot(M) # roughly equal variances / just one outlier/low value
qqnorm(resid(M)) 
qqline(resid(M)) # not great



# try using log-transformed stem height data given that assumptions are not ok
M <- lmer(ln.stem.ht ~ rest_status + poly(Elevation,3) + DomSpecies + poly(sp_prop,2) + (1|Site) + (1|Quadrat.f), data = spor_H, na.action = na.exclude)
summary(M)

# drop elevation 2 and 3 - only 1 is significant
M <- lmer(ln.stem.ht ~ rest_status + Elevation + DomSpecies + poly(sp_prop,2) + (1|Site) + (1|Quadrat.f), data = spor_H, na.action = na.exclude)
summary(M)

# check for collinearity between predictors
check_collinearity(M) # some VIF are >5 (moderate collinearity)

# drop species proportion as it has the highest VIF
M <- lmer(ln.stem.ht ~ rest_status + Elevation + DomSpecies + (1|Site) + (1|Quadrat.f), data = spor_H, na.action = na.exclude)
summary(M)

check_collinearity(M) # all VIF are <5 (low collinearity)

# residuals plots
plot(M) # roughly equal variances
qqnorm(resid(M)) 
qqline(resid(M)) # not good


# try square-root transformed?
M <- lmer(sq.stem.ht ~ rest_status + Elevation + DomSpecies + (1|Site) + (1|Quadrat.f), data = spor_H, na.action = na.exclude)
summary(M)

# residuals plots
plot(M) # good
qqnorm(resid(M)) 
qqline(resid(M)) # still not very good. could be due to 1-inflation. try a different model type?


# try robust lmer
M2 <- rlmer(ln.stem.ht ~ rest_status + Elevation + DomSpecies + (1|Site) + (1|Quadrat.f), data = spor_H, na.action = na.exclude)

# residuals plots
plot(M2) # 
qqnorm(resid(M2)) 
qqline(resid(M2))
# still not good. Looks similar to plots made with normal lmer rather than rlmer.
```


```{r Sporobolus stem height - restoration status - plot}
# plot
ggplot(spor_H, aes(x = Elevation, y = Stem_ht_mm)) +
  geom_point() +
  #geom_smooth(span = 1)
  stat_smooth(method="lm", se=TRUE, fill=NA,
                formula=y ~ poly(x, 2, raw=TRUE))

boxplot(spor_H$Stem_ht_mm ~ spor_H$rest_status)

boxplot(spor_H$Stem_ht_mm ~ spor_H$DomSpecies)
```




```{r Sporobolus stem height - YSR - Model building}
# create model
M_spor_H_stem_ht <- lmer(Stem_ht_mm ~ poly(YSR,2) + poly(Elevation,3) + DomSpecies + poly(sp_prop,2) + (1|Site) + (1|Quadrat.f), data = spor_H_rest, na.action = na.exclude)
summary(M_spor_H_stem_ht)

# drop elevation poly 3 and YSR poly 2
M <- lmer(Stem_ht_mm ~ YSR + poly(Elevation,2) + DomSpecies + poly(sp_prop,2) + (1|Site) + (1|Quadrat.f), data = spor_H_rest, na.action = na.exclude)
summary(M)

# check for collinearity between predictors
check_collinearity(M) # some VIF are >5 (moderate collinearity)

# drop DomSpecies, which has the highest VIF
M <- lmer(Stem_ht_mm ~ YSR + poly(Elevation,2) + poly(sp_prop,2) + (1|Site) + (1|Quadrat.f), data = spor_H_rest, na.action = na.exclude)
summary(M)

# now sp prop poly 2 is non-significant, drop it
M <- lmer(Stem_ht_mm ~ YSR + poly(Elevation,2) + sp_prop + (1|Site) + (1|Quadrat.f), data = spor_H_rest, na.action = na.exclude)
summary(M)

# residuals plots
plot(M) # roughly equal variances / just one outlier/low value
qqnorm(resid(M)) 
qqline(resid(M)) # mostly ok but high values diverge.. need to decide if OK

# try log-transformed data
M <- lmer(ln.stem.ht ~ YSR + poly(Elevation,2) + sp_prop + (1|Site) + (1|Quadrat.f), data = spor_H_rest, na.action = na.exclude)
summary(M)

# residuals plots
plot(M) # roughly equal variances / just one outlier/low value
qqnorm(resid(M)) 
qqline(resid(M)) # not great- high and low values diverge

# try sqrt-transformed data
M <- lmer(sq.stem.ht ~ YSR + poly(Elevation,2) + sp_prop + (1|Site) + (1|Quadrat.f), data = spor_H_rest, na.action = na.exclude)
summary(M)

# residuals plots
plot(M) # roughly equal variances / just one outlier/low value
qqnorm(resid(M)) 
qqline(resid(M)) # same as log-transformed

# try robust lmer
M <- rlmer(Stem_ht_mm ~ YSR + poly(Elevation,2) + sp_prop + (1|Site) + (1|Quadrat.f), data = spor_H_rest, na.action = na.exclude)
summary(M)

# residuals plots
plot(M) # roughly equal variances / just one outlier/low value
qqnorm(resid(M)) 
qqline(resid(M)) # worse than original
```


```{r Sporobolus stem height - YSR - plot}
# best model
M <- lmer(Stem_ht_mm ~ YSR + poly(Elevation,2) + sp_prop + (1|Site) + (1|Quadrat.f), data = spor_H_rest, na.action = na.exclude)
summary(M)

ggplot(spor_H_rest, aes(x = YSR, y = Stem_ht_mm)) +
  geom_point() +
  geom_smooth(method = lm)

# plot predicted values with ggeffects ggemmeans
predict_YSR <- ggemmeans(M, terms = c("YSR [all]"))
# view this result
print(predict_YSR)
# visualise this result
plot(predict_YSR, ci = T,add.data = TRUE, dot.alpha = 0.5,  jitter = 0.2)+
  ggtitle("") +  geom_line(size = 1.2) +
  labs(y = "Sporobolus stem height", x = "Years since restoration") +
  theme_classic()

# plot predicted values of Elevation with ggeffects ggemmeans
predict_YSR <- ggemmeans(M, terms = c("Elevation [all]"))
# view this result
print(predict_YSR)
# visualise this result
plot(predict_YSR, ci = T,add.data = TRUE, dot.alpha = 0.5,  jitter = 0.2)+
  ggtitle("") +  geom_line(size = 1.2) +
  labs(y = "Sporobolus stem height", x = "Elevation") +
  theme_classic()
# need to de-standardise elevation scale

ggplot(spor_H_rest, aes(x = sp_prop, y = Stem_ht_mm)) +
  geom_point() +
  geom_smooth(method = lm)
```



# 3aii. Stem diameter

```{r Sporobolus stem diameter - initial assumptions}
# test assumptions - linear relationship between predictors and response
# numeric predictors are species proportional cover and elevation
plot(spor_H$Stem_dia_mm ~ spor_H$sp_prop) # linearity is fine, but clearly stem diameter is 0- and 1-inflated. Need to figure out if this is an issue and if there's anything I can do about it.

plot(spor_H$Stem_dia_mm ~ spor_H$Elevation) # looks fine

plot(spor_H$Stem_dia_mm ~ spor_H$YSR) # fine
```


```{r Sporobolus stem diameter - restoration status - Model building}
# create model
M <- lmer(Stem_dia_mm ~ rest_status + Elevation + DomSpecies + sp_prop + (1|Site) + (1|Quadrat.f), data = spor_H, na.action = na.exclude)
summary(M)

# sp prop is clearly non-significant, drop it first
M <- lmer(Stem_dia_mm ~ rest_status + Elevation + DomSpecies + (1|Site) + (1|Quadrat.f), data = spor_H, na.action = na.exclude)
summary(M)

# check more model assumptions
# check for collinearity between predictors
check_collinearity(M) # all VIF < 5 (low collinearity)

# residuals plots
plot(M) # not equal variances / a couple outliers
qqnorm(resid(M)) 
qqline(resid(M)) # not good - high values diverge


# try using log-transformed stem diameter data given that assumptions are not ok
M <- lmer(ln.stem.dia ~ rest_status + Elevation + DomSpecies+ (1|Site) + (1|Quadrat.f), data = spor_H, na.action = na.exclude)
summary(M)

# residuals plots
plot(M) # roughly equal variances
qqnorm(resid(M)) 
qqline(resid(M)) # still not good - probably best option though


# try square-root transformed?
spor_H <- spor_H %>% mutate(sq.stem.dia = sqrt(Stem_dia_mm))

M <- lmer(sq.stem.dia ~ rest_status + Elevation + DomSpecies + (1|Site) + (1|Quadrat.f), data = spor_H, na.action = na.exclude)
summary(M)

# residuals plots
plot(M) # good
qqnorm(resid(M)) 
qqline(resid(M)) # still not very good. could be due to inflation. try a different model type?
```


```{r Sporobolus stem diameter - restoration status - plot}
# plot
ggplot(spor_H, aes(x = Elevation, y = Stem_dia_mm)) +
  geom_point() +
  stat_smooth(method="lm")

boxplot(spor_H$Stem_dia_mm ~ spor_H$rest_status)

boxplot(spor_H$Stem_dia_mm ~ spor_H$DomSpecies)

boxplot(spor_H$Stem_dia_mm ~ spor_H$Site)
```




```{r Sporobolus stem diameter - YSR - Model building}
# create model
M1 <- lmer(Stem_dia_mm ~ YSR + poly(Elevation,2) + DomSpecies + poly(sp_prop,2) + (1|Site) + (1|Quadrat.f), data = spor_H_rest, na.action = na.exclude)
summary(M1)

# check for collinearity between predictors
check_collinearity(M1) # some VIF are >5 (moderate collinearity)

# sp_prop has slightly higher VIF, drop sp_prop
M2 <- lmer(Stem_dia_mm ~ YSR + poly(Elevation,2) + DomSpecies + (1|Site) + (1|Quadrat.f), data = spor_H_rest, na.action = na.exclude)
summary(M2)

# residuals plots
plot(M2) # some high values/outliers/non-equal variances
qqnorm(resid(M2)) 
qqline(resid(M2)) # mostly ok but high values diverge.. not great

# try log-transformed data
M3 <- lmer(ln.stem.dia ~ YSR + poly(Elevation,2) + DomSpecies + (1|Site) + (1|Quadrat.f), data = spor_H_rest, na.action = na.exclude)
summary(M3)

# residuals plots
plot(M3) # roughly equal variances / just one outlier/low value
qqnorm(resid(M3)) 
qqline(resid(M3)) # maybe better than original?

# try sqrt-transformed data
M4 <- lmer(sq.stem.dia ~ YSR + poly(Elevation,2) + DomSpecies + (1|Site) + (1|Quadrat.f), data = spor_H_rest, na.action = na.exclude)
summary(M4)

# residuals plots
plot(M5) # roughly equal variances / just one outlier/low value
qqnorm(resid(M5)) 
qqline(resid(M5)) # worse than ln-transformed


# model with YSR as a polynomial
M6 <- lmer(ln.stem.dia ~ poly(YSR,2) + poly(Elevation,2) + DomSpecies + (1|Site) + (1|Quadrat.f), data = spor_H_rest, na.action = na.exclude)
summary(M6)

# residuals plots
plot(M6) # roughly equal variances / just one outlier/low value
qqnorm(resid(M6)) 
qqline(resid(M6)) # not good! can't use this
```


```{r Sporobolus stem diameter - YSR - plot}
# best model?
M4 <- lmer(ln.stem.dia ~ YSR + poly(Elevation,2) + DomSpecies + (1|Site) + (1|Quadrat.f), data = spor_H_rest, na.action = na.exclude)
summary(M4)

ggplot(spor_H_rest, aes(x = YSR, y = ln.stem.dia)) +
  geom_point() +
  geom_smooth(method = lm)

# plot predicted values with ggeffects ggemmeans
predict_YSR <- ggemmeans(M4, terms = c("YSR [all]"))
# view this result
print(predict_YSR)
# visualise this result
plot(predict_YSR, ci = T,add.data = TRUE, dot.alpha = 0.5,  jitter = 0.2)+
  ggtitle("") +  geom_line(size = 1.2) +
  scale_y_continuous(breaks = log(pretty(exp(spor_H_rest$ln.stem.dia))), labels = pretty(exp(spor_H_rest$ln.stem.dia))) +
  labs(y = "Sporobolus stem diameter (mm)", x = "Years since restoration") +
  theme_classic()

# plot natural stem diameters
ggplot(spor_H_nat, aes(x = Site, y = ln.stem.dia)) +
  geom_boxplot() +
  geom_jitter(width=0.1) +
    scale_y_continuous(breaks = log(pretty(exp(spor_H_nat$ln.stem.dia))), labels = pretty(exp(spor_H_nat$ln.stem.dia))) +
    labs(y = "Sporobolus stem diameter (mm)", x = "Site") +
  theme_classic() 

# elevation
ggplot(spor_H_rest, aes(x = Elevation, y = ln.stem.dia)) +
  geom_point() +
  geom_smooth(span = 1)

# dominant species
ggplot(spor_H_rest, aes(x = DomSpecies, y = ln.stem.dia)) +
  geom_boxplot()  +
  geom_point() +
    labs(y = "Log stem diameter") +
  theme_classic()

# need to back-transform and label these properly
```


# 3aiii. Sporobolus stem density 
- Stem density ~ YSR + Elevation + DomSpecies + SpeciesProportion + (1|Site)
- stem density is a positive integer value so should be able to conform to a roughly normal distribution

First assumption: linear relationship between predictors and response variable

Other assumptions:
- model residuals are normally distributed
- model residuals have equal variances
- model residuals are independent

```{r Sporoblus stem density - initial assumptions}
# test assumptions - linear relationship between predictors and response
# numeric predictors are species proportional cover and elevation
plot(spor_comm_H$total_stems ~ spor_comm_H$sp_prop) # potentially non-linear
ggplot(spor_comm_H, aes(x = sp_prop, y = total_stems)) +
  geom_point() +
  geom_smooth(span = 1) +
  geom_smooth(method = lm) # polynomial is a better fit, try that first

plot(spor_comm_H$total_stems ~ spor_comm_H$Elevation) # not obviously non-linear

plot(spor_comm_H$total_stems ~ spor_comm_H$YSR) # looks potentially non-linear
ggplot(spor_comm_H, aes(x = YSR, y = total_stems)) +
  geom_point() +
  geom_smooth(span = 2) +
  geom_smooth(method = lm) # non-linear is a better fit
```


```{r Sporoblus stem density - restoration status - model}
# create model
M_spor_H_stem_dens <- lmer(total_stems ~ rest_status + Elevation + DomSpecies + sp_prop + (1|Site), data = spor_comm_H, na.action = na.exclude)
# do I need to specify nesting here or will the model figure out due to the unique labelling of factors?
summary(M_spor_H_stem_dens)

# looks like elevation and species proportion influence Sporobolus stem density, but not restoration status (exploratory plots looked like restoration status did have an influence, but older sites were similar to natural sites, so wouldn't necessarily show up in this binary model)

# create a simplified model with only the significant factors
M_spor_H_stem_dens <- lmer(total_stems ~ Elevation + sp_prop + (1|Site), data = spor_comm_H, na.action = na.exclude)
summary(M_spor_H_stem_dens)
# elevation is no longer significant?


# check more model assumptions
# check for collinearity between predictors
check_collinearity(M_spor_H_stem_dens) # VIF < 5 (low collinearity) - good.

# residuals plots
plot(M_spor_H_stem_dens) # equal variances assumption is not ok
qqnorm(resid(M_spor_H_stem_dens)) 
qqline(resid(M_spor_H_stem_dens)) # not great but not terrible


# try with sq stem density
M_spor_H_stem_dens <- lmer(sq.stem.dens ~ Elevation + sp_prop + (1|Site), data = spor_comm_H, na.action = na.exclude)
summary(M_spor_H_stem_dens)
# elevation is no longer significant?


# check more model assumptions
# check for collinearity between predictors
check_collinearity(M_spor_H_stem_dens) # VIF < 5 (low collinearity) - good.

# residuals plots
plot(M_spor_H_stem_dens) # not good
qqnorm(resid(M_spor_H_stem_dens)) 
qqline(resid(M_spor_H_stem_dens)) # great


# remove sp_prop from model? as it's logically correlated with stem density
M_spor_H_stem_dens <- lmer(total_stems ~ rest_status + Elevation + DomSpecies + (1|Site), data = spor_comm_H, na.action = na.exclude)
# do I need to specify nesting here or will the model figure out due to the unique labelling of factors?
summary(M_spor_H_stem_dens)

# only DomSpecies sporobolus is significant - which again makes sense as there will be more stems when it's dominant
# not really happy with any of these models..
```


```{r Sporoblus stem density - restoration status - plot}
# plot
ggplot(spor_comm_H, aes(x = Elevation, y = total_stems)) +
  geom_point() +
  geom_smooth(method = lm)

ggplot(spor_comm_H, aes(x = sp_prop, y = total_stems)) +
  geom_point() +
  geom_smooth(method = lm)

boxplot(spor_comm_H$total_stems ~ spor_comm_H$rest_status)
```


```{r Sporoblus stem density - YSR - model}
M <- lmer(total_stems ~ poly(YSR,2) + Elevation + DomSpecies + poly(sp_prop,2) + (1|Site), data = spor_comm_H_res, na.action = na.exclude)
summary(M)

# everything except DomSpecies is significant. But sp_prop should probably be excluded.

M2 <- lmer(total_stems ~ poly(YSR,2) + Elevation + DomSpecies + (1|Site), data = spor_comm_H_res, na.action = na.exclude)
summary(M2)

# check more model assumptions
# check for collinearity between predictors
check_collinearity(M2) # all VIF are <5 (low collinearity)

# residuals plots
plot(M2) # not equal variances
qqnorm(resid(M2)) 
qqline(resid(M2)) # normality is great!

# try sqrt transform
M3 <- lmer(sq.stem.dens ~ poly(YSR,2) + Elevation + DomSpecies + (1|Site), data = spor_comm_H_res, na.action = na.exclude)
summary(M3)

plot(M3) # good
qqnorm(resid(M3)) 
qqline(resid(M3)) # a couple diverging values, but good enough
```


```{r Sporoblus stem density - YSR - plot}
# final model
M3 <- lmer(sq.stem.dens ~ poly(YSR,2) + Elevation + DomSpecies + (1|Site), data = spor_comm_H_res, na.action = na.exclude)
summary(M3)

# plot - YSR
ggplot(spor_comm_H_res, aes(x = YSR, y = sq.stem.dens)) +   
      geom_point(alpha = 0.5, na.rm = TRUE) +
      stat_smooth(span = 2) +
      theme_classic()

# plot predicted values with ggeffects ggemmeans
predict_YSR <- ggemmeans(M3, terms = c("YSR [all]"))
# view this result
print(predict_YSR)
# visualise this result
plot(predict_YSR, ci = T, add.data = TRUE, dot.alpha = 0.5,  jitter = 0.2)+
  ggtitle("") +  geom_line(size = 1.2)  +
  scale_y_continuous(breaks = sqrt(pretty((spor_H_rest$sq.stem.dens)^2)), labels = pretty((spor_H_rest$sq.stem.dens)^2)) +
  labs(y = "Sporobolus stems per square metre", x = "Years since restoration") +
  theme_classic()

# plot natural only
ggplot(spor_comm_H_nat, aes(x = Site, y = sq.stem.dens)) +
  geom_boxplot() +
  geom_jitter(width=0.1) +
     scale_y_continuous(breaks = sqrt(pretty((spor_comm_H_nat$sq.stem.dens)^2)), labels = pretty((spor_comm_H_nat$sq.stem.dens)^2)) +
    labs(y = "Sporobolus stems per square metre", x = "Site") +
  theme_classic() 

ggplot(spor_comm_H_res, aes(x = Elevation, y = total_stems)) +
  geom_point() +
  geom_smooth(method = lm)

ggplot(spor_comm_H_res, aes(x = sp_prop, y = total_stems)) +
  geom_point() +
  geom_smooth(method = lm)

ggplot(spor_comm_H_res, aes(x = YSR, y = total_stems)) +
  geom_point() +
  geom_smooth(method = lm)
```


# 3aiv - Sporobolus quantitative variables (multivariate)


Need to standardise these variables (centred on 0 with SD of 1) in order to model them together?

Need to account for the fact that stem density is measured at a quadrat level and stem height and diameter are measured at stem level.

```{r Sporobolus stem height diameter and density - Multivariate model}

```



# 3av - Sporobolus % species cover

Sporobolus % species cover
- Total cover ~ rest_status*YSR + Elevation + (1|Estuary) + (1|Site)
- beta distribution (proportional data with 2 categories - cover and non cover)

```{r Sporobolus species cover - model}
# turn species cover into a proportion between 0 and 1 instead of between 0 and 100
spor_comm <- spor_comm %>% mutate(sp_cover_prop = `Sp_cover_%`/100 -0.001)
# also included a tiny offset since it doesn't like values of exactly 1 - must be below 1.

# when YSR has NA values, this model comes up with an error
M <- glmmTMB(sp_cover_prop ~ rest_status/YSR + Elevation + Estuary + (1|Site), data = spor_comm, family = beta_family(link = "logit"), na.action = na.exclude)
# check whether this model makes sense and the correct way to include YSR as a fixed factor nested within rest_status
summary(M)

# excluding restoration status (and therefore natural sites) from the model removes the error
M <- glmmTMB(sp_cover_prop ~ YSR + Elevation + Estuary + (1|YSR), data = spor_comm, family = beta_family(link = "logit"), na.action = na.exclude)
# check whether this model makes sense and the correct way to include YSR as a fixed factor nested within rest_status
summary(M)
```


```{r sporobolus % cover univariate}
ggplot(spor_comm_H, aes(x = YSR, y = `Sp_cover_%`)) +
  geom_point() +
  geom_smooth(method = lm)

boxplot(spor_comm_H$`Sp_cover_%` ~ spor_comm_H$rest_status)
```


Other assumptions (??)


```{r Sporobolus species cover - plot}
(mm_plot <- ggplot(spor_comm, aes(x = YSR, y = sp_cover_prop)) +   
      geom_point(alpha = 0.5) +
    geom_smooth() + # meaningless
      theme_classic()) 
# older sites have consistently higher cover, compared with more varied cover at younger sites

spor_comm %>% subset(rest_status == "0") %>% 
  ggplot(., aes(x = Site, y=sp_cover_prop)) +
  geom_boxplot() +
  theme_classic()
```


# 3avi - Sporobous buds and flowers

Sporobolus buds and flowers - binary response variables

```{r Sporobolus buds and flowers - visualise distributions}
hist(spor_comm$Buds) # all zeroes - nothing to model
hist(spor_comm$Flowers) # almost all zeroes (only 5 quadrats with flowers) - not enough data to model
```

# 3avii - Sporobolus seeding

Sporobolus seeding - ordinal categorical response variable

```{r Sporobolus seeding - Data manipulation}
# make seeds into an ordinal variable
spor_comm$Seeds <- factor(spor_comm$Seeds, order = TRUE, levels = c("No", "Very few", "Few", "Some", "Lots"))
```

We can use the GLMMadaptive package to create a mixed model with an ordinal response variable.

Need to explore data to decide which family is most appropriate.

```{r Sporobolus seeding - model}
m_spor_seeds <- mixed_model(fixed = Seeds ~ YSR + Elevation + Estuary, random = ~ 1 | Site, 
                  data = spor_comm, family = binomial())
summary(m_spor_seeds)
```






# 3b - Sarcocornia



Sarcocornia reproduction

```{r Sarcocornia reproduction - Visualise distributions}
hist(sarc_comm$Buds) # no buds
hist(sarc_comm$Flowers) # there are occurrences of both flowers and no flowers

# make seeds a binary variable
sarc_comm <- sarc_comm %>% mutate(
  Seeds = case_when(
    Seeds == "Yes" ~ 1,
    Seeds == "No" ~ 0,
    Seeds == "Unknown" ~ NA,
    Seeds == "NA" ~ NA  
  )
)
hist(sarc_comm$Seeds) # there are occurrences of both seeds and no seeds

# are Flower and Seed presence correlated?
# see if there is a more formal way of testing this
sarc_comm$Seeds[sarc_comm$Flowers == 1] # there are 25 cases when Flowers are present. Seeds are present in 15 of these and no seeds in 8 of these.
sarc_comm$Seeds[sarc_comm$Flowers == 0] # there are 11 cases when Flowers are not present. Seeds are present in 5 of these and not present in 4 of these.
# therefore it seems like they aren't well correlated and can both be analysed
```

Need to decide whether we want to include these in a multivariate model together or have two separate models.

```{r Sarcocornia flowers - model}
m_sarc_flow <- glmmTMB(Flowers ~ YSR + Elevation + (1|Site), 
                  data = sarc_comm, family = binomial(), na.action = na.exclude)
# can't include estuary in the model as this species was only surveyed at Hunter
summary(m_sarc_flow)
```


```{r Sarcocornia seeds - model}
m_sarc_seeds <- glmmTMB(Seeds ~ YSR + Elevation + (1|Site), 
                  data = sarc_comm, family = binomial(), na.action = na.exclude)
# can't include estuary in the model as this species was only surveyed at Hunter
summary(m_sarc_seeds)
```




# 3c - Triglochin

Triglochin reproduction

```{r Triglochin reproduction - Visualise distributions}
hist(trig_comm$Buds) # there are occurrences of buds and no buds
hist(trig_comm$Flowers) # there are occurrences of both flowers and no flowers, but only about 2 occurrences of no flowers, which is not enough to analyse

# make seeds a binary variable
trig_comm <- trig_comm %>% mutate(
  Seeds = case_when(
    Seeds == "Yes" ~ 1,
    Seeds == "No" ~ 0,
    Seeds == "Unknown" ~ NA,
    Seeds == "NA" ~ NA  
  )
)
hist(trig_comm$Seeds) # there are occurrences of both seeds and no seeds

# are Bud and Seed presence correlated?
# see if there is a more formal way of testing this
trig_comm$Buds[trig_comm$Seeds == 1] # there are 12 cases when seeds are present. Buds are present in 7 of these and not present in 5 of these
trig_comm$Buds[trig_comm$Seeds == 0] # there are 21 cases when seeds are not present. Buds are present in 3 of these and not present in 18 of these.
trig_comm$Seeds[trig_comm$Buds == 1] # there are 10 cases when Buds are present. Seeds are present in 7 of these and not present in 3 of these
trig_comm$Seeds[trig_comm$Buds == 0] # there are 23 cases when Buds are not present. Seeds are present in 5 of these and not present in 18 of these.
# therefore I'm not sure if they're too correlated or not..
```




# 3d - pneumatophores







--------------

The following model formats are suggested by Jamil et al. (2012) for a simple model with one trait "z" and one fixed environmental vaiable "x":

M1 <- glmer(y ~ z + x + z:x + (1 + x|species) + (1|site), family=binomial(link=“logit”), data)

M0 <- glmer(y ~ z + x +(1 + x|species) + (1|site), family=binomial(link=“logit”), data)

However, "y" is species presence/absence or species abundance, which is not the focus of my analysis. I want to shift the focus to the trait value and have species proportions as a driver for that.

The first model includes the interaction between trait and environment and the second model is run without the interaction term so that we can compare the two models using an ANOVA to test the trait-environment interaction:

ANOVA(M0,M1)

```{r Test - log canopy height and elevation}
M1 <- glmer(y ~ z + x + z:x + (1 + x|species) + (1|site), family=binomial(link="logit"), data)

M0 <- glmer(y ~ z + x +(1 + x|species) + (1|site), family=binomial(link="logit"), data)

ANOVA(M0,M1)
```

